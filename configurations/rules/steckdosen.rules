// waschkeller.rules / 20150326
// Marianne Spiller <github@spiller.me>
// openhab-1.7.0-SNAPSHOT

import org.openhab.core.library.types.*
var Number Var_WH
// Anbieterpreis f√ºr KWh incl. MwSt.
var Number Naturkraft_KWH=0.51 // Naturkraft 14.5.2015

/////// Waschmaschine
//----------------------------------------------------------
// Umrechnung der Wh in KWh
//
rule "Berechne KWh"
when
  Item UG_Wirtschaftsraum_Waschmaschine_Gesamtverbrauch changed
then
  Var_WH = UG_Wirtschaftsraum_Waschmaschine_Gesamtverbrauch.state
  var Number Var_KWH = Var_WH / 1000
  UG_Wirtschaftsraum_Waschmaschine_Gesamtverbrauch_KWH.postUpdate(Var_KWH)
end

//----------------------------------------------------------
// Berechnung der bisher vom Geraet verursachten Kosten
//
rule "Berechne Kosten Waschmaschine"
when 
  Item UG_Wirtschaftsraum_Waschmaschine_Gesamtverbrauch_KWH changed
then
  var Number Var_KWH = UG_Wirtschaftsraum_Waschmaschine_Gesamtverbrauch_KWH.state
  var Number Kosten = Var_KWH * Naturkraft_KWH
  UG_Wirtschaftsraum_Waschmaschine_Summe.postUpdate(Kosten)
end 

//----------------------------------------------------------
// Update Last changed
//
rule "Update CCU2_Waschmaschine_LastUpdate"
when
  Item UG_Wirtschaftsraum_CCU2_Waschmaschine changed to ON
then
  UG_Wirtschaftsraum_CCU2_Waschmaschine_LastUpdate.postUpdate( now.toString() )
end

/////// Geschirrspueler
//----------------------------------------------------------
// Umrechnung der Wh in KWh
//
rule "Berechne KWh"
when
  Item EG_Kueche_Geschirrspueler_Gesamtverbrauch changed
then
  Var_WH = EG_Kueche_Geschirrspueler_Gesamtverbrauch.state
  var Number Var_KWH = Var_WH / 1000
  EG_Kueche_Geschirrspueler_Gesamtverbrauch_KWH.postUpdate(Var_KWH)
end

//----------------------------------------------------------
// Berechnung der bisher vom Geraet verursachten Kosten
//
rule "Berechne Kosten Geschirrspueler"
when 
  Item EG_Kueche_Geschirrspueler_Gesamtverbrauch_KWH changed
then
  var Number Var_KWH = EG_Kueche_Geschirrspueler_Gesamtverbrauch_KWH.state
  var Number Kosten = Var_KWH * Naturkraft_KWH
  EG_Kueche_Geschirrspueler_Summe.postUpdate(Kosten)
end 

//----------------------------------------------------------
// Update Last changed
//
rule "Update CCU2_Geschirrspueler_LastUpdate"
when
  Item EG_Kueche_CCU2_Geschirrspueler changed to ON
then
  EG_Kueche_CCU2_Geschirrspueler_LastUpdate.postUpdate( now.toString() )
end

//----------------------------------------------------------
// Schalte Schlafzimmerlampe mit der Fernbedienung
//
rule "Lampe Schlafzimmer"
when
        Item OG_Schlafzimmer_Power_Lamp_tog changed
then
        sendCommand(OG_Schlafzimmer_Power_Lamp, OG_Schlafzimmer_Power_Lamp_tog.state.toString )
end

//----------------------------------------------------------
// Schalte Hannes' Zimmerlampe mit der Fernbedienung
//
rule "Lampe Hannes"
when
        Item UG_Hannes_Power_Lamp_tog changed
then
        sendCommand(UG_Hannes_Power_Lamp, UG_Hannes_Power_Lamp_tog.state.toString )
end

//----------------------------------------------------------
// Schalte Schlafzimmer Gelsenstecker mit der Fernbedienung
//
rule "Gelsenstecker Schlafzimmer"
when
        Item OG_Schlafzimmer_Power_Gelsenstecker_tog changed
then
        sendCommand(OG_Schlafzimmer_Power_Gelsenstecker, OG_Schlafzimmer_Power_Gelsenstecker_tog.state.toString )
end

//----------------------------------------------------------
// Schalte Gelsenstecker ein wenn jemand zu Hause ist
//
rule "Gelsenstecker ein am Abend"
when
    // um 21:00
    Time cron "0 0 21 * * ?" or
    Item OG_Schlafzimmer_Door_left changed to OPEN or
    Item OG_Schlafzimmer_Door_right changed to OPEN
then
    if (JemandDa.state == ON) {
      sendCommand(OG_Schlafzimmer_Power_Gelsenstecker, ON)
    }
end

//----------------------------------------------------------
// Schalte Gelsenstecker aus
//
rule "Gelsenstecker aus"
when
    // um 03:00
    Time cron "0 0 6 * * ?" or
    Item OG_Schlafzimmer_Door_left changed to CLOSED or
    Item OG_Schlafzimmer_Door_right changed to CLOSED
then
    sendCommand(OG_Schlafzimmer_Power_Gelsenstecker, OFF)
end
